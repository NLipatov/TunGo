name: Release Workflow

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.0'

      - name: Build Linux x64 binary
        run: |
          cd src
          go mod tidy
          go build -o ../tungo-linux-x64

      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: tungo-linux-x64
          path: tungo-linux-x64

  build-installer-windows-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.0'

      - name: Install dependencies
        run: |
          cd src
          go mod tidy

      - name: Build Windows x64 binary
        run: |
          cd src
          go build -o ../tungo-win-x64.exe .

      - name: Create RunWithAdmin.ps1
        run: |
          @'
          Start-Process "$PSScriptRoot\tungo-win-x64.exe" -ArgumentList "c" -Verb RunAs
          '@ | Out-File RunWithAdmin.ps1 -Encoding utf8

      - name: Install Inno Setup via Chocolatey
        run: choco install innosetup -y

      - name: Download wintun archive
        run: |
          Invoke-WebRequest -Uri "https://www.wintun.net/builds/wintun-0.14.1.zip" -OutFile "wintun.zip"
          Expand-Archive -Path "wintun.zip" -DestinationPath "wintun"
          Copy-Item -Path "wintun\wintun\bin\amd64\wintun.dll" -Destination "."

      - name: Download TunGo.ico
        run: Invoke-WebRequest -Uri "https://tungo.ethacore.com/img/favicon.ico" -OutFile "TunGo.ico"

      - name: Create Inno Setup Script
        run: |
          @"
          [Setup]
          AppName=TunGo
          AppVersion=1.0
          DefaultDirName={pf}\TunGo
          DefaultGroupName=TunGo
          OutputBaseFilename=TunGo
          PrivilegesRequired=admin
          ArchitecturesAllowed=x86 x64
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "wintun.dll"; Flags: dontcopy
          Source: "tungo-win-x64.exe"; DestDir: "{app}"; Flags: ignoreversion
          Source: "TunGo.ico"; DestDir: "{app}"; Flags: ignoreversion
          Source: "RunWithAdmin.ps1"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\TunGo (Admin)"; Filename: "powershell.exe"; Parameters: "-ExecutionPolicy Bypass -File ""{app}\RunWithAdmin.ps1"""; WorkingDir: "{app}"; IconFilename: "{app}\TunGo.ico"

          [Code]
          procedure CopyWintunDll;
          var
            sysDir, targetFile, tempFile: string;
          begin
            sysDir := ExpandConstant('{sys}');
            targetFile := sysDir + '\wintun.dll';
            if not FileExists(targetFile) then begin
              ExtractTemporaryFile('wintun.dll');
              tempFile := ExpandConstant('{tmp}\wintun.dll');
              if not FileCopy(tempFile, targetFile, False) then
                MsgBox('Failed to copy wintun.dll to ' + sysDir, mbError, MB_OK);
            end;
          end;

          procedure CurStepChanged(CurStep: TSetupStep);
          begin
            if CurStep = ssPostInstall then
              CopyWintunDll;
          end;
          "@ | Out-File setup.iss -Encoding utf8

      - name: Build installer with Inno Setup
        run: ISCC.exe setup.iss

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: tungo-win-installer-x64
          path: Output\TunGo.exe

  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-installer-windows-x64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Get the latest Git tag
      - name: Get version from Git
        id: get_version
        run: echo "VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Download Linux binary artifact
        uses: actions/download-artifact@v4
        with:
          name: tungo-linux-x64
          path: linux

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: tungo-win-installer-x64
          path: win

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: Release ${{ env.VERSION }}
          body: "Release created manually via workflow_dispatch"
          draft: false
          prerelease: false

      - name: Upload Linux binary to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux/tungo-linux-x64
          asset_name: tungo-linux-x64
          asset_content_type: application/octet-stream

      - name: Upload Windows installer to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: win/TunGo.exe
          asset_name: tungo-installer-win-x64.exe
          asset_content_type: application/octet-stream
